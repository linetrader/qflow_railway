// prisma/schema/Center.prisma
model CenterManager {
  id            String   @id @default(cuid())
  userId        String   @unique
  percent       Decimal  @db.Decimal(5, 2)
  isActive      Boolean  @default(true)
  effectiveFrom DateTime @default(now())
  effectiveTo   DateTime?

  // ⬇️ relation name 고정
  user      User     @relation("CenterManager_User", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 활성/기간 조회 최적화
  @@index([isActive, effectiveTo])
  // (선택) 정렬 최적화용
  @@index([createdAt])
}

model UserCenterLink {
  id           String @id @default(cuid())
  userId       String         // 하부 유저(구매자 후보)
  centerUserId String         // 상위 센터 유저
  distance     Int            // 센터로부터의 깊이(1=직계)
  rank         Int            // 동일 distance 내 결정적 정렬용(1..N)

  // 감사/동기화
  createdAt   DateTime @default(now())   // ⬅️ 추가: 링크 생성 시각
  updatedAt   DateTime @updatedAt

  // ⬇️ relation name 고정
  user        User @relation("UserCenterLink_User", fields: [userId], references: [id], onDelete: Cascade)
  centerUser  User @relation("UserCenterLink_Center", fields: [centerUserId], references: [id], onDelete: Restrict)

  // 무결성
  @@unique([userId, centerUserId])
  // 조회 최적화(구매자→센터 조상들 정렬)
  @@index([userId, distance, rank])
  // (유지) 기타 조회 패턴
  @@index([userId, rank])
  @@index([centerUserId])
}

model CenterCommission {
  id              String @id @default(cuid())

  centerUserId    String
  // ⬇️ relation name 고정
  centerUser      User   @relation("CenterCommission_CenterUser", fields: [centerUserId], references: [id], onDelete: Restrict)

  sourceHistoryId String
  // ⬇️ relation name 고정
  sourceHistory   UserPackageHistory @relation("CenterCommission_SourceHistory", fields: [sourceHistoryId], references: [id], onDelete: Restrict)

  buyerUserId     String
  // ⬇️ relation name 고정
  buyerUser       User   @relation("CenterCommission_BuyerUser", fields: [buyerUserId], references: [id], onDelete: Restrict)

  // 스냅샷 필드(지급 당시 기준)
  percent          Decimal @db.Decimal(5, 2)     // 센터의 당시 퍼센트
  baseAmount       Decimal @db.Decimal(38, 18)   // 구매 기준액
  amount           Decimal @db.Decimal(38, 18)   // 지급액 = base * percent/100
  linkDistance     Int?                          // ⬅️ 추가: 구매자와 센터 간 거리 스냅샷(리포팅/감사)
  linkRank         Int?                          // ⬅️ 추가: 동일 distance 내 랭크(선택적 기록)

  status     ReferralCommissionStatus
  memo       String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // 1 히스토리당 같은 센터로는 1회만(멱등)
  @@unique([centerUserId, sourceHistoryId])
  // 조회 인덱스
  @@index([sourceHistoryId])        // ⬅️ 추가: 히스토리별 센터 커미션 조회 최적화
  @@index([centerUserId, createdAt])
  @@index([buyerUserId, createdAt])
  @@index([status, createdAt])
}
